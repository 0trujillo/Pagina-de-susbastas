<!DOCTYPE html>
<html>
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- Icono de perfil -->
    <img src="Imagenes/perfil.jpg" id="btnPerfil" style="width:50px;cursor:pointer; position:fixed; top:20px; right:20px;" alt="Perfil">

    <div class="container mt-5">
        <h2 class="text-center mb-4">Subastas Activas</h2>
        <div class="row" id="subastasContainer"></div>

        <!-- Apartado de Pujas Ganadas -->
        <h3 class="text-center mt-5 mb-3">üèÜ Pujas Ganadas</h3>
        <ul class="list-group" id="pujasGanadas"></ul>

        <!-- Resumen Final -->
        <h3 class="text-center mt-5 mb-3">üìë Resumen Final de Subastas</h3>
        <table class="table table-bordered table-striped text-center">
          <thead class="table-dark">
            <tr>
              <th>Imagen</th>
              <th>Art√≠culo</th>
              <th>Ganador</th>
              <th>Precio Final</th>
            </tr>
          </thead>
          <tbody id="tablaResumen"></tbody>
        </table>
    </div>

    <!-- Modal Perfil -->
    <div class="modal fade" id="perfilModal" tabindex="-1" aria-labelledby="perfilModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="perfilModalLabel">Perfil del Usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="mb-3">
            <button id="btnVerEnvios" class="btn btn-warning mt-3 w-100">üì¶ Ver Env√≠os</button>
          </div>
          <div class="modal-body">
            <p><strong>Presupuesto actual:</strong> <span id="presupuestoActual">$0</span></p>
            <div class="mb-3">
              <label for="montoRecarga" class="form-label">Recargar presupuesto</label>
              <input type="number" id="montoRecarga" class="form-control" min="1" max="100000" placeholder="M√°ximo $100000">
            </div>
            <button id="btnRecargar" class="btn btn-success">Recargar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let presupuesto = 5000; 
    const presupuestoMaximo = 100000;

    function formatearDinero(monto) {
      return monto.toLocaleString("es-CL", { style: "currency", currency: "CLP" });
    }

    function actualizarPresupuestoUI() {
      document.getElementById("presupuestoActual").textContent = formatearDinero(presupuesto);
    }

    let subastas = [
      { id: 1, nombre: "Laptop Gamer", precio: 100, tiempo: 0, ganador: null, ultimaPujaUsuario: null, imagen: "Imagenes/Lgamer.jpg" },
      { id: 2, nombre: "Smartphone", precio: 250, tiempo: 0, ganador: null, ultimaPujaUsuario: null, imagen: "Imagenes/cel.webp" },
      { id: 3, nombre: "Auriculares", precio: 75, tiempo: 0, ganador: null, ultimaPujaUsuario: null, imagen: "Imagenes/auri.jpg"  },
      { id: 4, nombre: "Carta Pok√©mon", precio: 1000, tiempo: 0, ganador: null, ultimaPujaUsuario: null, imagen: "Imagenes/ctpokemon.jpg"},
      { id: 5, nombre: "PlayStation 5", precio: 500, tiempo: 0, ganador: null, ultimaPujaUsuario: null, imagen: "Imagenes/play5.jpg"},
      { id: 6, nombre: "Bicicleta", precio: 300, tiempo: 0, ganador: null, ultimaPujaUsuario: null, imagen: "Imagenes/bici.webp"  }
    ];

    const container = document.getElementById("subastasContainer");
    const listaGanadas = document.getElementById("pujasGanadas");
    const tablaResumen = document.getElementById("tablaResumen");

    function formatearTiempo(segundos) {
      const min = Math.floor(segundos / 60);
      const sec = segundos % 60;
      return `${min}:${sec < 10 ? "0" + sec : sec}`;
    }

    function iniciarBot(subasta) {
      const precioElemento = document.getElementById(`precio-${subasta.id}`);

      function pujaBot() {
        if (subasta.tiempo > 0) {
          if (subasta.ganador !== "bot") {
            subasta.precio += Math.floor(Math.random() * 20) + 5;
            precioElemento.textContent = formatearDinero(subasta.precio);
            subasta.ganador = "bot";
          }

          let delay = Math.random() * 4000 + 2000; 
          if (subasta.precio >= 2000) delay *= 2;
          if (subasta.precio >= 5000) delay *= 3;

          setTimeout(pujaBot, delay);
        }
      }

      setTimeout(pujaBot, Math.random() * 4000 + 2000);
    }

    function mostrarSubastaAleatoria() {
      if (subastas.length === 0) return;

      const index = Math.floor(Math.random() * subastas.length);
      const subasta = subastas.splice(index, 1)[0];
      subasta.tiempo = Math.floor(Math.random() * (240 - 60 + 1)) + 60;

      const col = document.createElement("div");
      col.classList.add("col-md-4");

      col.innerHTML = `
        <div class="card mb-4">
          <img src="${subasta.imagen}" class="card-img-top" alt="${subasta.nombre}">
          <div class="card-body">
            <h5 class="card-title">${subasta.nombre}</h5>
            <p class="card-text">Precio actual: <strong id="precio-${subasta.id}">${formatearDinero(subasta.precio)}</strong></p>
            <p class="card-text">Tiempo restante: <span class="text-danger" id="tiempo-${subasta.id}">${formatearTiempo(subasta.tiempo)}</span></p>
            <button class="btn btn-primary w-100">Pujar</button>
          </div>
        </div>
      `;

      container.appendChild(col);

      const botonPuja = col.querySelector("button");
      const precioElemento = document.getElementById(`precio-${subasta.id}`);
      const tiempoElemento = document.getElementById(`tiempo-${subasta.id}`);

      botonPuja.addEventListener("click", () => {
        if (subasta.tiempo > 0) {
          if (presupuesto >= 10) {
            subasta.precio += 10;
            precioElemento.textContent = formatearDinero(subasta.precio);
            subasta.ganador = "usuario";
            subasta.ultimaPujaUsuario = subasta.precio;
            presupuesto -= 10;
            actualizarPresupuestoUI();

            if (!col.querySelector(".ultimaPuja")) {
                const p = document.createElement("p");
                p.classList.add("text-success", "ultimaPuja");
                col.querySelector(".card-body").appendChild(p);
            }
            col.querySelector(".ultimaPuja").textContent = `Tu √∫ltima puja: ${formatearDinero(subasta.ultimaPujaUsuario)}`;
          } else {
            alert("‚ö†Ô∏è No tienes suficiente presupuesto para pujar.");
          }
        }
      });

      const intervaloTiempo = setInterval(() => {
        if (subasta.tiempo > 0) {
          subasta.tiempo--;
          tiempoElemento.textContent = formatearTiempo(subasta.tiempo);

          // Estado en tiempo real
          if (!col.querySelector(".estadoPuja")) {
              const p = document.createElement("p");
              p.classList.add("estadoPuja", "fw-bold");
              col.querySelector(".card-body").appendChild(p);
          }
          const estadoElemento = col.querySelector(".estadoPuja");
          if (subasta.ganador === "usuario") {
              estadoElemento.textContent = "¬°Vas ganando! üéâ";
              estadoElemento.classList.remove("text-danger");
              estadoElemento.classList.add("text-success");
          } else if (subasta.ganador === "bot") {
              estadoElemento.textContent = "Perdiendo... üë§";
              estadoElemento.classList.remove("text-success");
              estadoElemento.classList.add("text-danger");
          } else {
              estadoElemento.textContent = "";
          }

        } else {
          clearInterval(intervaloTiempo);
          tiempoElemento.textContent = `Ganador: ${subasta.ganador === "usuario" ? "T√∫ üéâ" : "Anonimo üë§"}`;

          botonPuja.textContent = "Terminada";
          botonPuja.disabled = true;

          if (!col.querySelector(".estadoPuja")) {
              const p = document.createElement("p");
              p.classList.add("estadoPuja", "fw-bold");
              col.querySelector(".card-body").appendChild(p);
          }
          const estadoElemento = col.querySelector(".estadoPuja");
          if (subasta.ganador === "usuario") {
              estadoElemento.textContent = "¬°Ganaste! üéâ";
              estadoElemento.classList.remove("text-danger");
              estadoElemento.classList.add("text-success");
          } else {
              estadoElemento.textContent = "Perdiste... üë§";
              estadoElemento.classList.remove("text-success");
              estadoElemento.classList.add("text-danger");
          }

          if (subasta.ganador === "usuario") {
            const li = document.createElement("li");
            li.classList.add("list-group-item", "list-group-item-success");
            li.textContent = `${subasta.nombre} - Ganaste con ${formatearDinero(subasta.ultimaPujaUsuario)}`;
            listaGanadas.appendChild(li);
          }

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><img src="${subasta.imagen}" style="width:80px; height:auto;"></td>
            <td>${subasta.nombre}</td>
            <td>${subasta.ganador === "usuario" ? "T√∫ üéâ" : "Anonimo üë§"}</td>
            <td>${formatearDinero(subasta.precio)}</td>
          `;
          tablaResumen.appendChild(tr);
        }
      }, 1000);

      iniciarBot(subasta);
    }

    mostrarSubastaAleatoria();
    setInterval(() => {
      if (subastas.length > 0) {
        mostrarSubastaAleatoria();
      }
    }, 15000);

    const perfilModal = new bootstrap.Modal(document.getElementById("perfilModal"));
    document.getElementById("btnPerfil").addEventListener("click", () => {
      actualizarPresupuestoUI();
      perfilModal.show();
    });

    document.getElementById("btnRecargar").addEventListener("click", () => {
      const monto = parseInt(document.getElementById("montoRecarga").value);
      if (isNaN(monto) || monto <= 0) {
        alert("‚ö†Ô∏è Ingresa un monto v√°lido.");
        return;
      }
      if (presupuesto + monto > presupuestoMaximo) {
        alert("‚ö†Ô∏è El presupuesto no puede superar $100000.");
        return;
      }
      presupuesto += monto;
      actualizarPresupuestoUI();
      alert(`‚úÖ Recargaste ${formatearDinero(monto)}. Nuevo presupuesto: ${formatearDinero(presupuesto)}`);
      document.getElementById("montoRecarga").value = "";
    });

  document.getElementById("btnVerEnvios").addEventListener("click", () => {
  window.location.href = "Envio.html";
  });

    </script>
</body>
</html>
