<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Envíos - Subastas Online</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <!-- Header compacto -->
    <header class="bg-primary text-white py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-8">
                    <h1 class="h4 mb-0">
                        <i class="fas fa-shipping-fast me-2"></i>Seguimiento de Envíos
                    </h1>
                    <small>Rastrea tus productos ganados en subastas</small>
                </div>
                <div class="col-4 text-end">
                    <img src="Imagenes/perfil.jpg" id="btnPerfil" 
                         style="width:40px; height:40px; cursor:pointer;" 
                         class="rounded-circle" 
                         alt="Perfil de usuario">
                </div>
            </div>
        </div>
    </header>

    <!-- Navegación compacta -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
        <div class="container">
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="Inicio.html">
                    <i class="fas fa-home me-1"></i>Inicio
                </a>
                <a class="nav-link active" href="Envio.html">
                    <i class="fas fa-shipping-fast me-1"></i>Envíos
                </a>
            </div>
            <span class="navbar-text small">
                <i class="fas fa-clock me-1"></i>
                <span id="fechaActual"></span>
            </span>
        </div>
    </nav>

    <!-- Contenido principal -->
    <main class="container my-4">
        <!-- Estadísticas compactas -->
        <section class="row mb-4">
            <div class="col-md-3 col-6 mb-3">
                <div class="card border-0 bg-light">
                    <div class="card-body p-3 text-center">
                        <i class="fas fa-box text-primary mb-1" style="font-size: 1.5rem;"></i>
                        <h6 class="card-title mb-0" id="enviosActivosCount">0</h6>
                        <small class="text-muted">Envíos Activos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="card border-0 bg-light">
                    <div class="card-body p-3 text-center">
                        <i class="fas fa-check-circle text-success mb-1" style="font-size: 1.5rem;"></i>
                        <h6 class="card-title mb-0" id="enviosCompletadosCount">0</h6>
                        <small class="text-muted">Completados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="card border-0 bg-light">
                    <div class="card-body p-3 text-center">
                        <i class="fas fa-truck text-info mb-1" style="font-size: 1.5rem;"></i>
                        <h6 class="card-title mb-0" id="enviosTransitoCount">0</h6>
                        <small class="text-muted">En Tránsito</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="card border-0 bg-light">
                    <div class="card-body p-3 text-center">
                        <i class="fas fa-calendar-alt text-warning mb-1" style="font-size: 1.5rem;"></i>
                        <h6 class="card-title mb-0" id="proximaEntrega">Hoy</h6>
                        <small class="text-muted">Próxima Entrega</small>
                    </div>
                </div>
            </div>
        </section>

        <!-- Buscador -->
        <section class="row mb-4">
            <div class="col-lg-8 mx-auto">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-search me-2"></i>Buscar Envío
                        </h5>
                        <form id="formBusqueda" onsubmit="buscarEnvio(event)">
                            <div class="input-group">
                                <input type="text" id="codigoSeguimiento" class="form-control" 
                                       placeholder="Ingresa tu código de seguimiento..."
                                       required minlength="5">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-search me-1"></i>Buscar
                                </button>
                            </div>
                            <div class="invalid-feedback">
                                Por favor ingresa un código válido (mínimo 5 caracteres)
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Productos reclamados pendientes de envío -->
        <section id="productos-reclamados" class="mb-4" style="display: none;">
            <h4 class="mb-3">
                <i class="fas fa-gift text-success me-2"></i>Productos Reclamados
            </h4>
            <div class="row" id="productosReclamadosContainer">
                <!-- Los productos reclamados aparecerán aquí -->
            </div>
        </section>

        <!-- Mis envíos activos -->
        <section class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>
                    <i class="fas fa-box-open text-primary me-2"></i>Mis Envíos Activos
                </h4>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="filtrarEnvios('todos')">
                        Todos
                    </button>
                    <button class="btn btn-outline-warning" onclick="filtrarEnvios('transito')">
                        En Tránsito
                    </button>
                    <button class="btn btn-outline-info" onclick="filtrarEnvios('preparando')">
                        Preparando
                    </button>
                </div>
            </div>
            <div class="row" id="enviosContainer">
                <!-- Los envíos se cargarán aquí -->
            </div>
        </section>

        <!-- Detalle de seguimiento -->
        <section id="detalleEnvio" style="display: none;" class="mb-4">
            <div class="row">
                <div class="col-lg-10 mx-auto">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-route me-2"></i>Detalle del Envío
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-barcode me-2"></i>Código:</h6>
                                    <p class="fw-bold" id="codigoDetalle">-</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-calendar me-2"></i>Entrega Estimada:</h6>
                                    <p class="fw-bold text-primary" id="fechaEstimada">-</p>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-map-marker-alt me-2"></i>Origen:</h6>
                                    <p id="direccionOrigen">-</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-home me-2"></i>Destino:</h6>
                                    <p id="direccionDestino">-</p>
                                </div>
                            </div>

                            <h6><i class="fas fa-timeline me-2"></i>Historial:</h6>
                            <div class="tracking-timeline" id="timeline">
                                <!-- Timeline se carga aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Historial compacto -->
        <section class="mb-4">
            <h4 class="mb-3">
                <i class="fas fa-history text-secondary me-2"></i>Historial de Envíos
            </h4>
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th>Código</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historialEnvios">
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox me-2"></i>
                                        No hay envíos registrados
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Perfil compacto -->
    <div class="modal fade" id="perfilModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-circle me-2"></i>Mi Perfil
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h6>Envíos Activos</h6>
                            <span class="badge bg-primary fs-6" id="modalEnviosActivos">0</span>
                        </div>
                        <div class="col-6">
                            <h6>Completados</h6>
                            <span class="badge bg-success fs-6" id="modalEnviosCompletados">0</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="window.location.href='Inicio.html'">
                        <i class="fas fa-home me-2"></i>Volver al Inicio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de formulario de envío -->
    <div class="modal fade" id="formularioEnvioModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-truck me-2"></i>Configurar Envío
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEnvio" onsubmit="procesarEnvio(event)">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nombreCompleto" class="form-label">Nombre Completo</label>
                                <input type="text" id="nombreCompleto" class="form-control" required minlength="2">
                                <div class="invalid-feedback">Ingresa tu nombre completo</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="tel" id="telefono" class="form-control" required 
                                       pattern="[0-9\+\-\s\(\)]+" minlength="8">
                                <div class="invalid-feedback">Ingresa un teléfono válido</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="direccionCompleta" class="form-label">Dirección Completa</label>
                            <textarea id="direccionCompleta" class="form-control" rows="2" 
                                      required minlength="10" placeholder="Calle, número, comuna, ciudad"></textarea>
                            <div class="invalid-feedback">Ingresa una dirección completa</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="comuna" class="form-label">Comuna</label>
                                <select id="comuna" class="form-select" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Santiago">Santiago</option>
                                    <option value="Las Condes">Las Condes</option>
                                    <option value="Providencia">Providencia</option>
                                    <option value="Ñuñoa">Ñuñoa</option>
                                    <option value="Maipú">Maipú</option>
                                    <option value="La Florida">La Florida</option>
                                    <option value="Puente Alto">Puente Alto</option>
                                </select>
                                <div class="invalid-feedback">Selecciona una comuna</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="tipoEnvio" class="form-label">Tipo de Envío</label>
                                <select id="tipoEnvio" class="form-select" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="express">Express (1-2 días) - $5,990</option>
                                    <option value="normal">Normal (3-5 días) - $2,990</option>
                                    <option value="economico">Económico (5-7 días) - $1,490</option>
                                </select>
                                <div class="invalid-feedback">Selecciona un tipo de envío</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="comentarios" class="form-label">Comentarios adicionales (opcional)</label>
                            <textarea id="comentarios" class="form-control" rows="2" 
                                      placeholder="Referencias, horarios preferidos, etc."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" form="formEnvio" class="btn btn-success">
                        <i class="fas fa-check me-2"></i>Confirmar Envío
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer compacto -->
    <footer class="bg-light py-3 border-top">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <small class="text-muted">
                        <i class="fas fa-shipping-fast me-1"></i>
                        Subastas Online - Seguimiento de Envíos
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <small class="text-muted">
                        <i class="fas fa-phone me-1"></i>
                        Soporte: +56 9 1234 5678
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="envio.js"></script>
</body>
</html>

<script>
    // JavaScript para página de envíos
class EnviosManager {
    constructor() {
        this.envios = [
            {
                id: 1,
                producto: "Laptop Gamer",
                imagen: "Imagenes/Lgamer.jpg",
                codigoSeguimiento: "ENV001234567",
                estado: "EN_TRANSITO",
                fechaEnvio: "2025-01-08",
                fechaEstimada: "2025-01-12",
                direccionOrigen: "Santiago Centro, Santiago, RM",
                direccionDestino: "Las Condes, Santiago, RM",
                empresaTransporte: "StarkenEx",
                historial: [
                    { fecha: "2025-01-08 10:30", estado: "PREPARANDO", descripcion: "Paquete preparado", ubicacion: "Centro Santiago" },
                    { fecha: "2025-01-08 14:15", estado: "EN_TRANSITO", descripcion: "En camino", ubicacion: "Ruta Santiago - Las Condes" },
                    { fecha: "2025-01-09 09:20", estado: "EN_TRANSITO", descripcion: "En distribución local", ubicacion: "Las Condes" }
                ]
            },
            {
                id: 2,
                producto: "PlayStation 5",
                imagen: "Imagenes/play5.jpg",
                codigoSeguimiento: "ENV001234568",
                estado: "PREPARANDO",
                fechaEnvio: "2025-01-09",
                fechaEstimada: "2025-01-13",
                direccionOrigen: "Valparaíso, V Región",
                direccionDestino: "Providencia, Santiago, RM",
                empresaTransporte: "ChileExpress",
                historial: [
                    { fecha: "2025-01-09 08:00", estado: "PENDIENTE", descripcion: "Envío registrado", ubicacion: "Valparaíso" },
                    { fecha: "2025-01-09 11:30", estado: "PREPARANDO", descripcion: "Preparando paquete", ubicacion: "Centro Valparaíso" }
                ]
            }
        ];

        this.historialCompleto = [
            {
                producto: "Smartphone",
                codigoSeguimiento: "ENV001234560",
                estado: "ENTREGADO",
                fechaEnvio: "2025-01-01",
                fechaEntrega: "2025-01-05"
            },
            {
                producto: "Auriculares",
                codigoSeguimiento: "ENV001234561", 
                estado: "ENTREGADO",
                fechaEnvio: "2024-12-28",
                fechaEntrega: "2025-01-02"
            }
        ];

        this.init();
    }

    init() {
        this.cargarProductosReclamados();
        this.configurarEventListeners();
        this.cargarEnviosActivos();
        this.cargarHistorial();
        this.actualizarEstadisticas();
        this.mostrarFechaActual();
    }

    configurarEventListeners() {
        // Modal de perfil
        const perfilModal = new bootstrap.Modal(document.getElementById('perfilModal'));
        document.getElementById('btnPerfil').addEventListener('click', () => {
            this.actualizarModalPerfil();
            perfilModal.show();
        });

        // Validación del formulario de búsqueda
        document.getElementById('codigoSeguimiento').addEventListener('input', this.validarCodigoBusqueda);

        // Validación del formulario de envío
        this.configurarValidacionFormulario();
    }

    validarCodigoBusqueda() {
        const input = document.getElementById('codigoSeguimiento');
        const valor = input.value.trim();
        
        if (valor.length < 5 && valor.length > 0) {
            input.setCustomValidity('El código debe tener al menos 5 caracteres');
            input.classList.add('is-invalid');
        } else {
            input.setCustomValidity('');
            input.classList.remove('is-invalid');
        }
    }

    configurarValidacionFormulario() {
        const form = document.getElementById('formEnvio');
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
            input.addEventListener('input', () => {
                if (input.checkValidity()) {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                } else {
                    input.classList.remove('is-valid');
                    input.classList.add('is-invalid');
                }
            });
        });
    }

    cargarProductosReclamados() {
        const productosGanados = JSON.parse(localStorage.getItem('productosGanados')) || [];
        const container = document.getElementById('productosReclamadosContainer');
        const section = document.getElementById('productos-reclamados');
        
        if (productosGanados.length > 0) {
            section.style.display = 'block';
            container.innerHTML = '';
            
            productosGanados.forEach(producto => {
                if (producto.estado === 'PENDIENTE_ENVIO') {
                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4 mb-3';
                    
                    col.innerHTML = `
                        <div class="card border-success">
                            <img src="${producto.imagen}" class="card-img-top" alt="${producto.nombre}" 
                                 style="height: 200px; object-fit: cover;">
                            <div class="card-body">
                                <h6 class="card-title text-success">
                                    <i class="fas fa-trophy me-2"></i>${producto.nombre}
                                </h6>
                                <p class="card-text small text-muted">
                                    Precio ganado: <strong>${this.formatearDinero(producto.precio)}</strong>
                                </p>
                                <button class="btn btn-success btn-sm w-100" 
                                        onclick="enviosManager.configurarEnvio('${producto.id}')">
                                    <i class="fas fa-truck me-2"></i>Configurar Envío
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(col);
                }
            });
        }
    }

    configurarEnvio(productoId) {
        const modal = new bootstrap.Modal(document.getElementById('formularioEnvioModal'));
        modal.show();
        
        // Guardar el ID del producto para procesar después
        window.productoEnProceso = productoId;
    }

    procesarEnvio(event) {
        event.preventDefault();
        
        const form = event.target;
        if (!form.checkValidity()) {
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        // Simular procesamiento
        const datos = {
            nombre: document.getElementById('nombreCompleto').value,
            telefono: document.getElementById('telefono').value,
            direccion: document.getElementById('direccionCompleta').value,
            comuna: document.getElementById('comuna').value,
            tipoEnvio: document.getElementById('tipoEnvio').value,
            comentarios: document.getElementById('comentarios').value
        };

        // Generar código de seguimiento
        const codigoSeguimiento = 'ENV' + Date.now().toString().slice(-9);
        
        // Crear nuevo envío
        const nuevoEnvio = {
            id: Date.now(),
            producto: "Producto Reclamado",
            codigoSeguimiento: codigoSeguimiento,
            estado: "PREPARANDO",
            fechaEnvio: new Date().toISOString().split('T')[0],
            fechaEstimada: this.calcularFechaEstimada(datos.tipoEnvio),
            direccionOrigen: "Centro de Distribución, Santiago",
            direccionDestino: `${datos.direccion}, ${datos.comuna}`,
            empresaTransporte: "Express Delivery",
            historial: [
                {
                    fecha: new Date().toISOString(),
                    estado: "PREPARANDO",
                    descripcion: "Envío configurado y en preparación",
                    ubicacion: "Centro de Distribución"
                }
            ]
        };

        this.envios.push(nuevoEnvio);
        
        // Actualizar localStorage
        this.actualizarProductoEnLocalStorage(window.productoEnProceso, codigoSeguimiento);
        
        // Cerrar modal y mostrar éxito
        const modal = bootstrap.Modal.getInstance(document.getElementById('formularioEnvioModal'));
        modal.hide();
        
        this.mostrarNotificacion(`✅ Envío configurado exitosamente. Código: ${codigoSeguimiento}`, 'success');
        
        // Recargar la página
        setTimeout(() => {
            this.cargarProductosReclamados();
            this.cargarEnviosActivos();
            this.actualizarEstadisticas();
        }, 1000);
    }

    calcularFechaEstimada(tipoEnvio) {
        const hoy = new Date();
        let dias = 3; // default
        
        switch(tipoEnvio) {
            case 'express': dias = 2; break;
            case 'normal': dias = 4; break;
            case 'economico': dias = 6; break;
        }
        
        hoy.setDate(hoy.getDate() + dias);
        return hoy.toISOString().split('T')[0];
    }

    actualizarProductoEnLocalStorage(productoId, codigoSeguimiento) {
        let productos = JSON.parse(localStorage.getItem('productosGanados')) || [];
        productos = productos.map(producto => {
            if (producto.id == productoId) {
                return {
                    ...producto,
                    estado: 'ENVIADO',
                    codigoSeguimiento: codigoSeguimiento
                };
            }
            return producto;
        });
        localStorage.setItem('productosGanados', JSON.stringify(productos));
    }

    formatearDinero(monto) {
        return monto.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
    }

    formatearFecha(fecha) {
        return new Date(fecha).toLocaleDateString('es-CL', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    obtenerIconoEstado(estado) {
        const iconos = {
            'PENDIENTE': 'fas fa-clock text-warning',
            'PREPARANDO': 'fas fa-box text-info',
            'EN_TRANSITO': 'fas fa-truck text-primary',
            'EN_REPARTO': 'fas fa-route text-success',
            'ENTREGADO': 'fas fa-check-circle text-success',
            'DEVUELTO': 'fas fa-undo text-danger'
        };
        return iconos[estado] || 'fas fa-question-circle text-secondary';
    }

    obtenerClaseEstado(estado) {
        const clases = {
            'PENDIENTE': 'bg-warning text-dark',
            'PREPARANDO': 'bg-info text-white',
            'EN_TRANSITO': 'bg-primary text-white',
            'EN_REPARTO': 'bg-success text-white',
            'ENTREGADO': 'bg-success text-white',
            'DEVUELTO': 'bg-danger text-white'
        };
        return clases[estado] || 'bg-secondary text-white';
    }

    cargarEnviosActivos() {
        const container = document.getElementById('enviosContainer');
        container.innerHTML = '';

        if (this.envios.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="card border-0 bg-light">
                        <div class="card-body text-center py-5">
                            <i class="fas fa-shipping-fast fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No tienes envíos activos</h5>
                            <p class="text-muted">Los productos que ganes en subastas aparecerán aquí</p>
                            <a href="Inicio.html" class="btn btn-primary">
                                <i class="fas fa-gavel me-2"></i>Ver Subastas
                            </a>
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        this.envios.forEach(envio => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-3';
            
            col.innerHTML = `
                <div class="card h-100 shadow-sm envio-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${envio.producto}</h6>
                            <span class="badge ${this.obtenerClaseEstado(envio.estado)} badge-sm">
                                ${envio.estado.replace('_', ' ')}
                            </span>
                        </div>
                        <p class="card-text small text-muted mb-2">
                            <i class="fas fa-barcode me-1"></i>${envio.codigoSeguimiento}
                        </p>
                        <p class="card-text small mb-2">
                            <i class="fas fa-truck me-1"></i>${envio.empresaTransporte}
                        </p>
                        <p class="card-text small mb-3">
                            <i class="fas fa-calendar me-1"></i>
                            Entrega: ${this.formatearFecha(envio.fechaEstimada)}
                        </p>
                        <button class="btn btn-outline-primary btn-sm w-100" 
                                onclick="enviosManager.verDetalleEnvio('${envio.codigoSeguimiento}')">
                            <i class="fas fa-eye me-1"></i>Ver Detalle
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(col);
        });
    }

    cargarHistorial() {
        const tbody = document.getElementById('historialEnvios');
        tbody.innerHTML = '';

        if (this.historialCompleto.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                        <i class="fas fa-inbox me-2"></i>
                        No hay envíos en el historial
                    </td>
                </tr>
            `;
            return;
        }

        this.historialCompleto.forEach(envio => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${envio.producto}</td>
                <td><code class="small">${envio.codigoSeguimiento}</code></td>
                <td>
                    <span class="badge ${this.obtenerClaseEstado(envio.estado)} badge-sm">
                        ${envio.estado}
                    </span>
                </td>
                <td class="small">${this.formatearFecha(envio.fechaEnvio)}</td>
                <td class="text-center">
                    <button class="btn btn-outline-info btn-sm" 
                            onclick="enviosManager.verDetalleEnvio('${envio.codigoSeguimiento}')" 
                            title="Ver detalle">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    buscarEnvio(event) {
        event.preventDefault();
        
        const codigo = document.getElementById('codigoSeguimiento').value.trim();
        const input = document.getElementById('codigoSeguimiento');
        
        if (!input.checkValidity()) {
            input.classList.add('is-invalid');
            return;
        }
        
        this.verDetalleEnvio(codigo);
    }

    verDetalleEnvio(codigo) {
        const envio = this.envios.find(e => e.codigoSeguimiento === codigo) || 
                     this.historialCompleto.find(e => e.codigoSeguimiento === codigo);

        if (!envio) {
            this.mostrarNotificacion('❌ No se encontró el envío con ese código', 'warning');
            return;
        }

        const envioCompleto = this.envios.find(e => e.codigoSeguimiento === codigo);
        if (!envioCompleto) {
            this.mostrarNotificacion('ℹ️ Este envío ya fue completado', 'info');
            return;
        }

        // Llenar datos del detalle
        document.getElementById('codigoDetalle').textContent = envioCompleto.codigoSeguimiento;
        document.getElementById('fechaEstimada').textContent = this.formatearFecha(envioCompleto.fechaEstimada);
        document.getElementById('direccionOrigen').textContent = envioCompleto.direccionOrigen;
        document.getElementById('direccionDestino').textContent = envioCompleto.direccionDestino;

        // Generar timeline
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = '';

        envioCompleto.historial.forEach((evento, index) => {
            const isActive = index === envioCompleto.historial.length - 1;
            const isCompleted = index < envioCompleto.historial.length - 1;
            
            const item = document.createElement('div');
            item.className = `timeline-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
            
            item.innerHTML = `
                <div class="card border-0 shadow-sm mb-2">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1 small">${evento.estado.replace('_', ' ')}</h6>
                                <p class="mb-1 text-muted small">${evento.descripcion}</p>
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt me-1"></i>${evento.ubicacion}
                                </small>
                            </div>
                            <small class="text-muted">${new Date(evento.fecha).toLocaleString('es-CL')}</small>
                        </div>
                    </div>
                </div>
            `;
            
            timeline.appendChild(item);
        });

        // Mostrar sección de detalle
        document.getElementById('detalleEnvio').style.display = 'block';
        document.getElementById('detalleEnvio').scrollIntoView({ behavior: 'smooth' });
    }

    actualizarEstadisticas() {
        const activos = this.envios.length;
        const completados = this.historialCompleto.filter(e => e.estado === 'ENTREGADO').length;
        const enTransito = this.envios.filter(e => e.estado === 'EN_TRANSITO').length;
        
        document.getElementById('enviosActivosCount').textContent = activos;
        document.getElementById('enviosCompletadosCount').textContent = completados;
        document.getElementById('enviosTransitoCount').textContent = enTransito;
        
        // Próxima entrega
        if (this.envios.length > 0) {
            const proximaFecha = this.envios
                .map(e => new Date(e.fechaEstimada))
                .sort((a, b) => a - b)[0];
            const hoy = new Date();
            const diffDias = Math.ceil((proximaFecha - hoy) / (1000 * 60 * 60 * 24));
            
            if (diffDias <= 0) {
                document.getElementById('proximaEntrega').textContent = 'Hoy';
            } else if (diffDias === 1) {
                document.getElementById('proximaEntrega').textContent = 'Mañana';
            } else {
                document.getElementById('proximaEntrega').textContent = `${diffDias} días`;
            }
        }
    }

    actualizarModalPerfil() {
        document.getElementById('modalEnviosActivos').textContent = this.envios.length;
        document.getElementById('modalEnviosCompletados').textContent = 
            this.historialCompleto.filter(e => e.estado === 'ENTREGADO').length;
    }

    mostrarFechaActual() {
        const fecha = new Date().toLocaleDateString('es-CL', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('fechaActual').textContent = fecha;
    }

    mostrarNotificacion(mensaje, tipo = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    filtrarEnvios(tipo) {
        const cards = document.querySelectorAll('.envio-card');
        cards.forEach(card => {
            const badge = card.querySelector('.badge');
            const estado = badge.textContent.trim().toUpperCase().replace(' ', '_');
            
            switch(tipo) {
                case 'todos':
                    card.parentElement.style.display = 'block';
                    break;
                case 'transito':
                    card.parentElement.style.display = estado === 'EN_TRANSITO' ? 'block' : 'none';
                    break;
                case 'preparando':
                    card.parentElement.style.display = estado === 'PREPARANDO' ? 'block' : 'none';
                    break;
            }
        });
    }
}

// Funciones globales
function buscarEnvio(event) {
    enviosManager.buscarEnvio(event);
}

function procesarEnvio(event) {
    enviosManager.procesarEnvio(event);
}

function filtrarEnvios(tipo) {
    enviosManager.filtrarEnvios(tipo);
}

// Inicializar cuando se carga la página
document.addEventListener('DOMContentLoaded', () => {
    window.enviosManager = new EnviosManager();
});
</script>